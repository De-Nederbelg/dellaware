<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planning Tool – Firestore + Lokale fallback</title>
    <style>
        :root {
            --bg: #0b1020;
            --panel: #141a32;
            --muted: #8b95b5;
            --text: #e7ecff;
            --primary: #5b8cff;
            --ok: #22c55e;
            --warn: #f59e0b;
            --bad: #ef4444;
            --radius: 16px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, #0b1020, #0b1020 30%, #0e1430);
            color: var(--text);
            font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif
        }

        header {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: saturate(1.2) blur(8px);
            background: rgba(10, 14, 35, .6);
            border-bottom: 1px solid #1f2747
        }

        header .bar {
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 1200px;
            margin: auto;
            padding: 12px 16px
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700
        }

        .logo i {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: conic-gradient(var(--primary), #8a9dff)
        }

        nav {
            margin-left: auto;
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        nav button {
            background: transparent;
            border: 1px solid #2a3564;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 999px;
            cursor: pointer
        }

        nav button.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff
        }

        .wrap {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 16px
        }

        .grid {
            display: grid;
            gap: 16px
        }

        .cols-3 {
            grid-template-columns: repeat(3, 1fr)
        }

        .cols-2 {
            grid-template-columns: repeat(2, 1fr)
        }

        .panel {
            background: linear-gradient(180deg, #121735, #0f1531);
            border: 1px solid #202a54;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .25)
        }

        .panel h2 {
            margin: 0;
            padding: 14px 16px;
            border-bottom: 1px solid #202a54;
            font-size: 16px
        }

        .panel .content {
            padding: 14px 16px
        }

        .muted {
            color: var(--muted)
        }

        .kpi {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 12px;
            background: #101632;
            border: 1px solid #1d254a
        }

        .kpi b {
            font-size: 24px
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #25305c;
            background: #0e1430;
            color: var(--text)
        }

        .row {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .btn {
            cursor: pointer;
            border: 1px solid #2a3564;
            padding: 10px 12px;
            border-radius: 10px;
            background: #101736;
            color: var(--text)
        }

        .btn.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff
        }

        .btn.ghost {
            background: transparent
        }

        .tag {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid #2a3564;
            color: #c7d2fe
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px
        }

        th {
            font-size: 12px;
            color: var(--muted);
            text-align: left;
            padding: 0 8px
        }

        td {
            background: #0f1531;
            border: 1px solid #1f2a57;
            border-left: none;
            border-right: none;
            padding: 10px 8px
        }

        tr td:first-child {
            border-left: 1px solid #1f2a57;
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px
        }

        tr td:last-child {
            border-right: 1px solid #1f2a57;
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px
        }

        .hide {
            display: none
        }

        #offline-banner {
            display: none;
            background: #f59e0b;
            color: #0b1020;
            text-align: center;
            padding: 10px 14px;
            font-weight: 700;
            border-bottom: 1px solid #eab308
        }

        #offline-banner .btn {
            margin-left: 8px
        }

        @media (max-width:900px) {
            .cols-3 {
                grid-template-columns: 1fr
            }

            .cols-2 {
                grid-template-columns: 1fr
            }

            .row {
                grid-template-columns: 1fr
            }

            nav {
                width: 100%
            }
        }
    </style>
</head>

<body>
    <div id="offline-banner">Firestore niet bereikbaar – wil je <button class="btn" id="retry-btn">opnieuw
            proberen</button> of <button class="btn ghost" id="local-btn">lokaal verder</button>?</div>
    <header>
        <div class="bar">
            <div class="logo"><i></i> Planning Tool</div>
            <span class="muted">Firestore + lokale fallback</span>
            <nav id="tabs">
                <button data-tab="dashboard" class="active">Dashboard</button>
                <button data-tab="tasks">Taken</button>
                <button data-tab="plants">Plants</button>
                <button data-tab="employees">Werknemers</button>
                <button data-tab="notifications">Meldingen</button>
            </nav>
        </div>
    </header>
    <main class="wrap">
        <section id="tab-dashboard">
            <div class="grid cols-3">
                <div class="panel">
                    <h2>Vandaag</h2>
                    <div class="content grid cols-2">
                        <div class="kpi"><span class="muted">Open taken</span><b id="kpi-open">0</b></div>
                        <div class="kpi"><span class="muted">In uitvoering</span><b id="kpi-inprogress">0</b></div>
                        <div class="kpi"><span class="muted">Afgerond</span><b id="kpi-done">0</b></div>
                        <div class="kpi"><span class="muted">Zieke werknemers</span><b id="kpi-sick">0</b></div>
                    </div>
                </div>
                <div class="panel">
                    <h2>Snel acties</h2>
                    <div class="content actions">
                        <button class="btn primary" onclick="ui.openCreateTask()">Nieuwe taak</button>
                        <button class="btn" onclick="ui.openAbsence()">Afwezigheid melden</button>
                        <button class="btn ghost" onclick="exportCSV()">Export CSV</button>
                    </div>
                </div>
                <div class="panel">
                    <h2>Laatste meldingen</h2>
                    <div class="content" id="latest-notifs"><span class="muted">Geen meldingen…</span></div>
                </div>
            </div>
        </section>
        <section id="tab-tasks" class="hide">
            <div class="panel">
                <h2>Taken beheren</h2>
                <div class="content">
                    <div class="row">
                        <div>
                            <label>Zoek</label>
                            <input id="task-search" placeholder="naam, plant of werknemer" oninput="filters.apply()" />
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="task-status" onchange="filters.apply()">
                                <option value="">Alle</option>
                                <option value="open">Open</option>
                                <option value="in_progress">In uitvoering</option>
                                <option value="done">Afgerond</option>
                            </select>
                        </div>
                    </div>
                    <div class="actions" style="margin:12px 0">
                        <button class="btn primary" onclick="ui.openCreateTask()">+ Taak</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Naam</th>
                                <th>Plant</th>
                                <th>Werknemer</th>
                                <th>Duur (u)</th>
                                <th>Status</th>
                                <th>Acties</th>
                            </tr>
                        </thead>
                        <tbody id="task-rows"></tbody>
                    </table>
                </div>
            </div>
        </section>
        <section id="tab-plants" class="hide">
            <div class="panel">
                <h2>Plants</h2>
                <div class="content">
                    <div class="actions" style="margin-bottom:12px">
                        <button class="btn primary" onclick="ui.openCreatePlant()">+ Plant</button>
                    </div>
                    <div id="plant-cards" class="grid cols-3"></div>
                </div>
            </div>
        </section>
        <section id="tab-employees" class="hide">
            <div class="panel">
                <h2>Werknemers</h2>
                <div class="content">
                    <div class="actions" style="margin-bottom:12px">
                        <button class="btn primary" onclick="ui.openCreateEmployee()">+ Werknemer</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Naam</th>
                                <th>Team</th>
                                <th>Plant</th>
                                <th>Status</th>
                                <th>Acties</th>
                            </tr>
                        </thead>
                        <tbody id="emp-rows"></tbody>
                    </table>
                </div>
            </div>
        </section>
        <section id="tab-notifications" class="hide">
            <div class="panel">
                <h2>Meldingen</h2>
                <div class="content">
                    <div class="actions" style="margin-bottom:12px">
                        <button class="btn" onclick="ui.openAbsence()">Afwezigheid melden</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Tijd</th>
                                <th>Type</th>
                                <th>Bericht</th>
                                <th>Acties</th>
                            </tr>
                        </thead>
                        <tbody id="notif-rows"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
    <dialog id="modal"
            style="padding:0;border:none;border-radius:16px;background:#0f1531;color:var(--text);max-width:640px;width:92%">
        <form method="dialog" style="margin:0">
            <header
                    style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #1f2747">
                <b id="modal-title">Bewerken</b>
                <button class="btn ghost" value="cancel">✕</button>
            </header>
            <div id="modal-body" style="padding:16px"></div>
            <footer
                    style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #1f2747">
                <button class="btn ghost" value="cancel">Annuleren</button>
                <button class="btn primary" id="modal-ok" value="default">Opslaan</button>
            </footer>
        </form>
    </dialog>
    <script type="module">
        // Firebase imports (modular SDK)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, onSnapshot, query, where, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

        // ===== CONFIG =====
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "",
            appId: ""
        };

        // ===== STATE & HELPERS =====
        const $ = s => document.querySelector(s); const $$ = s => Array.from(document.querySelectorAll(s));
        const banner = $('#offline-banner');
        const tabs = $('#tabs');

        const state = { mode: 'cloud', tasks: [], plants: [], employees: [], notifications: [] };

        const ui = { // modal helpers
            open(html, title = 'Bewerken', onOk = null) {
                const modal = $('#modal'); $('#modal-title').textContent = title; $('#modal-body').innerHTML = html; modal.returnValue = ''; modal.showModal();
                if (onOk) { const handler = () => { if (modal.returnValue !== "cancel") onOk(); modal.removeEventListener('close', handler); }; modal.addEventListener('close', handler); }
            },
            openCreateTask() {
                const html = `
          <div class="row">
            <div><label>Naam</label><input id="t-name" required placeholder="bv. Onderhoud lijn 3"/></div>
            <div><label>Duur (uren)</label><input id="t-dur" type="number" min="0" step="0.5" value="1"/></div>
          </div>
          <div class="row">
            <div><label>Plant</label><select id="t-plant"></select></div>
            <div><label>Werknemer (optioneel)</label><select id="t-emp"><option value="">—</option></select></div>
          </div>
          <div><label>Status</label><select id="t-status"><option value="open">Open</option><option value="in_progress">In uitvoering</option><option value="done">Afgerond</option></select></div>`;
                ui.open(html, 'Nieuwe taak', async () => {
                    const name = $('#t-name').value.trim(); const duration = parseFloat($('#t-dur').value) || 0; const plantId = $('#t-plant').value; const employeeId = $('#t-emp').value || null; const status = $('#t-status').value;
                    if (!name || !plantId) return;
                    await data.tasks.create({ name, duration, plantId, employeeId, status });
                });
                fillOptions('plants', '#t-plant');
                fillOptions('employees', '#t-emp', (e) => `${e.firstName} ${e.lastName}`);
            },
            openEditTask(task) {
                const html = `
          <div class="row">
            <div><label>Naam</label><input id="t-name" value="${task.name}"/></div>
            <div><label>Duur (uren)</label><input id="t-dur" type="number" min="0" step="0.5" value="${task.duration || 0}"/></div>
          </div>
          <div class="row">
            <div><label>Plant</label><select id="t-plant"></select></div>
            <div><label>Werknemer</label><select id="t-emp"><option value="">—</option></select></div>
          </div>
          <div><label>Status</label><select id="t-status"><option value="open">Open</option><option value="in_progress">In uitvoering</option><option value="done">Afgerond</option></select></div>`;
                ui.open(html, 'Taak bewerken', async () => {
                    const name = $('#t-name').value.trim(); const duration = parseFloat($('#t-dur').value) || 0; const plantId = $('#t-plant').value; const employeeId = $('#t-emp').value || null; const status = $('#t-status').value;
                    await data.tasks.update(task.id, { name, duration, plantId, employeeId, status });
                });
                fillOptions('plants', '#t-plant', null, task.plantId); fillOptions('employees', '#t-emp', (e) => `${e.firstName} ${e.lastName}`, task.employeeId || ''); $('#t-status').value = task.status;
            },
            openCreatePlant() {
                const html = `
          <div class="row"><div><label>Naam</label><input id="p-name"/></div><div><label>Capaciteit</label><input id="p-cap" type="number" min="0" value="0"/></div></div>
          <div class="row"><div><label>Locatie</label><input id="p-loc" placeholder="Stad, Land"/></div><div><label>Status</label><select id="p-status"><option>actief</option><option>onderhoud</option><option>stilgelegd</option></select></div></div>`;
                ui.open(html, 'Nieuwe plant', async () => { const name = $('#p-name').value.trim(); if (!name) return; await data.plants.create({ name, capacity: parseInt($('#p-cap').value) || 0, location: $('#p-loc').value, status: $('#p-status').value }); });
            },
            openCreateEmployee() {
                const html = `
          <div class="row"><div><label>Voornaam</label><input id="e-fn"/></div><div><label>Achternaam</label><input id="e-ln"/></div></div>
          <div class="row"><div><label>Team</label><input id="e-team"/></div><div><label>Plant</label><select id="e-plant"></select></div></div>
          <div><label>Status</label><select id="e-status"><option value="active">actief</option><option value="locked">geblokkeerd</option><option value="sick">ziek</option></select></div>`;
                ui.open(html, 'Nieuwe werknemer', async () => { const firstName = $('#e-fn').value.trim(); const lastName = $('#e-ln').value.trim(); if (!firstName || !lastName) return; await data.employees.create({ firstName, lastName, team: $('#e-team').value, plantId: $('#e-plant').value, status: $('#e-status').value }); });
                fillOptions('plants', '#e-plant');
            },
            openAbsence() {
                const html = `
          <div class="row"><div><label>Werknemer</label><select id="a-emp"></select></div><div><label>Type</label><select id="a-type"><option value="illness">Ziekte</option><option value="holiday">Vakantie</option></select></div></div>
          <div class="row"><div><label>Van</label><input id="a-from" type="date"/></div><div><label>Tot</label><input id="a-to" type="date"/></div></div>
          <small class="muted">Bij ziekte worden taken in deze periode automatisch vrijgegeven.</small>`;
                ui.open(html, 'Afwezigheid melden', async () => {
                    const employeeId = $('#a-emp').value; const type = $('#a-type').value; const from = $('#a-from').value; const to = $('#a-to').value; if (!employeeId || !from || !to) return;
                    await data.notifications.create({ type, message: `${type === 'illness' ? 'Ziekte' : 'Vakantie'} gemeld voor werknemer ${employeeId} van ${from} tot ${to}` });
                    await data.employees.update(employeeId, { status: type === 'illness' ? 'sick' : 'active' });
                    // vrijgeven taken van werknemer
                    const tasks = [...state.tasks].filter(t => t.employeeId === employeeId).map(t => ({ id: t.id, ...t }));
                    await Promise.all(tasks.map(t => data.tasks.update(t.id, { employeeId: null, status: 'open' })));
                });
                fillOptions('employees', '#a-emp', (e) => `${e.firstName} ${e.lastName}`);
            }
        };

        // ===== DATA LAYER (Cloud + Local) =====
        const Local = (() => {
            const KEY = 'planning_local_v1';
            function load() { try { return JSON.parse(localStorage.getItem(KEY)) || { plants: [], employees: [], tasks: [], notifications: [] }; } catch { return { plants: [], employees: [], tasks: [], notifications: [] }; } }
            function save(d) { localStorage.setItem(KEY, JSON.stringify(d)); }
            let db = load();
            const uid = () => 'loc_' + Math.random().toString(36).slice(2, 10);
            const now = () => ({ seconds: Math.floor(Date.now() / 1000) });
            const api = {
                subscribe(col, cb) { // simple poll-based pseudo-live
                    cb(db[col].map(x => ({ id: x.id, ...x })));
                },
                list(col) { return Promise.resolve(db[col].map(x => ({ id: x.id, ...x }))); },
                create(col, data) { const id = uid(); const item = { id, ...data }; if (col === 'tasks') item.createdAt = now(); if (col === 'notifications') item.createdAt = now(); db[col].push(item); save(db); return Promise.resolve({ id }); },
                update(col, id, data) { const i = db[col].findIndex(x => x.id === id); if (i > -1) { db[col][i] = { ...db[col][i], ...data }; save(db); } return Promise.resolve(); },
                delete(col, id) { db[col] = db[col].filter(x => x.id !== id); save(db); return Promise.resolve(); }
            };
            // seed
            if (!db.plants.length) {
                const p1 = { id: uid(), name: 'Plant A', location: 'Gent, BE', capacity: 120, status: 'actief' };
                const p2 = { id: uid(), name: 'Plant B', location: 'Antwerpen, BE', capacity: 80, status: 'onderhoud' };
                const e1 = { id: uid(), firstName: 'Sara', lastName: 'De Vos', team: 'Alpha', plantId: p1.id, status: 'active' };
                const e2 = { id: uid(), firstName: 'Tom', lastName: 'Peeters', team: 'Beta', plantId: p1.id, status: 'active' };
                const t1 = { id: uid(), name: 'Inspectie lijn 2', plantId: p1.id, employeeId: e1.id, duration: 2, status: 'open', createdAt: now() };
                const t2 = { id: uid(), name: 'Smeren transportband', plantId: p2.id, employeeId: null, duration: 1.5, status: 'open', createdAt: now() };
                db = { plants: [p1, p2], employees: [e1, e2], tasks: [t1, t2], notifications: [] }; save(db);
            }
            return api;
        })();

        const Cloud = (() => {
            let app, db;
            async function init() { app = initializeApp(firebaseConfig); db = getFirestore(app); try { await enableIndexedDbPersistence(db); } catch (e) { } return db; }
            return {
                async tryConnect() { try { if (!db) await init(); await getDocs(collection(db, 'plants')); return true; } catch (e) { console.warn('Firestore connect fail', e); return false; } },
                subscribe(col, cb) { return onSnapshot(collection(db, col), (snap) => { cb(snap.docs.map(d => ({ id: d.id, ...d.data() }))); }); },
                list(col) { return getDocs(collection(db, col)).then(s => s.docs.map(d => ({ id: d.id, ...d.data() }))); },
                async create(col, data) { if (col === 'tasks' || col === 'notifications') data.createdAt = serverTimestamp(); const ref = await addDoc(collection(db, col), data); return { id: ref.id }; },
                update(col, id, data) { return updateDoc(doc(db, col, id), data); },
                delete(col, id) { return deleteDoc(doc(db, col, id)); },
            };
        })();

        // Unified API
        const data = {
            _backend: Cloud,
            useLocal() { this._backend = Local; state.mode = 'local'; banner.style.display = 'none'; notify('info', 'Overgeschakeld naar lokale modus'); bootSubscriptions(); },
            async tryCloud() { const ok = await Cloud.tryConnect(); if (!ok) throw new Error('cloud-fail'); this._backend = Cloud; state.mode = 'cloud'; },
            subscribe(col, cb) { return this._backend.subscribe(col, cb); },
            list(col) { return this._backend.list(col); },
            create(col, payload) { return this._backend.create(col, payload); },
            update(col, id, payload) { return this._backend.update(col, id, payload); },
            delete(col, id) { return this._backend.delete(col, id); },
            // convenience namespaces
            tasks: { create: (p) => data.create('tasks', p), update: (id, p) => data.update('tasks', id, p), delete: (id) => data.delete('tasks', id) },
            plants: { create: (p) => data.create('plants', p), update: (id, p) => data.update('plants', id, p), delete: (id) => data.delete('plants', id) },
            employees: { create: (p) => data.create('employees', p), update: (id, p) => data.update('employees', id, p) },
            notifications: { create: (p) => data.create('notifications', p), delete: (id) => data.delete('notifications', id) }
        };

        // ===== UI WIRING =====
        tabs.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return; $$('#tabs button').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); const key = e.target.dataset.tab; $$('#tab-dashboard, #tab-tasks, #tab-plants, #tab-employees, #tab-notifications').forEach(s => s.classList.add('hide')); $('#tab-' + key).classList.remove('hide');
        });

        function updateKPIs() { const open = state.tasks.filter(t => t.status === 'open').length; const prog = state.tasks.filter(t => t.status === 'in_progress').length; const done = state.tasks.filter(t => t.status === 'done').length; const sick = state.employees.filter(e => e.status === 'sick').length; $('#kpi-open').textContent = open; $('#kpi-inprogress').textContent = prog; $('#kpi-done').textContent = done; $('#kpi-sick').textContent = sick; }

        const filters = { apply() { renderTasks(); } };

        function renderTasks() {
            const q = ($('#task-search')?.value || '').toLowerCase(); const st = $('#task-status')?.value || ''; const tbody = $('#task-rows'); if (!tbody) return; tbody.innerHTML = '';
            const rows = state.tasks.filter(t => { if (st && t.status !== st) return false; if (q) { const plant = state.plants.find(p => p.id === t.plantId); const emp = state.employees.find(e => e.id === t.employeeId); const hay = [t.name, plant?.name, emp ? `${emp.firstName} ${emp.lastName}` : ''].join(' ').toLowerCase(); if (!hay.includes(q)) return false; } return true; })
                .map(t => {
                    const plant = state.plants.find(p => p.id === t.plantId); const emp = state.employees.find(e => e.id === t.employeeId); return `<tr>
          <td>${t.name || '-'}</td>
          <td>${plant?.name || '-'}</td>
          <td>${emp ? `${emp.firstName} ${emp.lastName}` : '—'}</td>
          <td>${t.duration || 0}</td>
          <td><span class="tag">${labelStatus(t.status)}</span></td>
          <td class="actions">
            <button class="btn" onclick='markInProgress("${t.id}")'>Start</button>
            <button class="btn" onclick='markDone("${t.id}")'>Klaar</button>
            <button class="btn" onclick='assignTask("${t.id}")'>Toewijzen</button>
            <button class="btn" onclick='editTask("${t.id}")'>Bewerken</button>
            <button class="btn" onclick='removeTask("${t.id}")'>Verwijderen</button>
          </td>
        </tr>` }).join('');
            tbody.innerHTML = rows || `<tr><td colspan="6" class="muted">Geen taken gevonden.</td></tr>`; updateKPIs();
        }

        function labelStatus(s) { return s === 'open' ? 'Open' : s === 'in_progress' ? 'In uitvoering' : 'Afgerond'; }
        async function markInProgress(id) { await data.tasks.update(id, { status: 'in_progress' }); }
        async function markDone(id) { await data.tasks.update(id, { status: 'done' }); }
        async function removeTask(id) { if (confirm('Taak verwijderen?')) await data.tasks.delete(id); }
        function editTask(id) { const t = state.tasks.find(x => x.id === id); ui.openEditTask(t); }
        async function assignTask(id) { const t = state.tasks.find(x => x.id === id); const html = `<label>Werknemer</label><select id="as-emp"></select>`; ui.open(html, 'Taak toewijzen', async () => { const employeeId = $('#as-emp').value || null; await data.tasks.update(id, { employeeId }); }); fillOptions('employees', '#as-emp', (e) => `${e.firstName} ${e.lastName}`, t.employeeId || ''); }
        window.markInProgress = markInProgress; window.markDone = markDone; window.removeTask = removeTask; window.assignTask = assignTask; window.editTask = editTask;

        function renderPlants() {
            const host = $('#plant-cards'); if (!host) return; host.innerHTML = ''; state.plants.forEach(p => {
                const tasksAt = state.tasks.filter(t => t.plantId === p.id); const open = tasksAt.filter(t => t.status === 'open').length; const done = tasksAt.filter(t => t.status === 'done').length; const emp = state.employees.filter(e => e.plantId === p.id && e.status !== 'locked').length; const div = document.createElement('div'); div.className = 'panel'; div.innerHTML = `<h2>${p.name}</h2>
          <div class="content">
            <div class="grid cols-2">
              <div class="kpi"><span class="muted">Locatie</span><b>${p.location || '-'}</b></div>
              <div class="kpi"><span class="muted">Capaciteit</span><b>${p.capacity || 0}</b></div>
              <div class="kpi"><span class="muted">Werknemers</span><b>${emp}</b></div>
              <div class="kpi"><span class="muted">Open taken</span><b>${open}</b></div>
              <div class="kpi"><span class="muted">Afgerond</span><b>${done}</b></div>
            </div>
            <div class="actions" style="margin-top:12px">
              <button class="btn" onclick='editPlant("${p.id}")'>Bewerken</button>
              <button class="btn" onclick='deletePlant("${p.id}")'>Verwijderen</button>
            </div>
          </div>`; host.appendChild(div);
            }); if (!state.plants.length) { host.innerHTML = `<div class="muted">Nog geen plants… Voeg er één toe.</div>` }
        }
        function editPlant(id) {
            const p = state.plants.find(x => x.id === id); const html = `
        <div class="row"><div><label>Naam</label><input id="p-name" value="${p.name}"/></div><div><label>Capaciteit</label><input id="p-cap" type="number" value="${p.capacity || 0}"/></div></div>
        <div class="row"><div><label>Locatie</label><input id="p-loc" value="${p.location || ''}"/></div><div><label>Status</label><select id="p-status"><option>actief</option><option>onderhoud</option><option>stilgelegd</option></select></div></div>`; ui.open(html, 'Plant bewerken', async () => { await data.plants.update(id, { name: $('#p-name').value, capacity: parseInt($('#p-cap').value) || 0, location: $('#p-loc').value, status: $('#p-status').value }); }); setTimeout(() => { $('#p-status').value = p.status || 'actief' }, 0);
        }
        async function deletePlant(id) { if (confirm('Plant verwijderen?')) await data.plants.delete(id); }
        window.editPlant = editPlant; window.deletePlant = deletePlant;

        function renderEmployees() {
            const tbody = $('#emp-rows'); if (!tbody) return; tbody.innerHTML = ''; state.employees.forEach(e => {
                const plant = state.plants.find(p => p.id === e.plantId); const status = e.status === 'sick' ? 'ziek' : e.status === 'locked' ? 'geblokkeerd' : 'actief'; const tr = document.createElement('tr'); tr.innerHTML = `<td>${e.firstName} ${e.lastName}</td><td>${e.team || '-'}</td><td>${plant?.name || '-'}</td><td><span class="tag">${status}</span></td>
          <td class="actions"><button class="btn" onclick='editEmployee("${e.id}")'>Bewerken</button><button class="btn" onclick='lockEmployee("${e.id}")'>Lock</button></td>`; tbody.appendChild(tr);
            }); if (!state.employees.length) { tbody.innerHTML = `<tr><td colspan="5" class="muted">Nog geen werknemers…</td></tr>` }
        }
        function editEmployee(id) {
            const e = state.employees.find(x => x.id === id); const html = `
        <div class="row"><div><label>Voornaam</label><input id="e-fn" value="${e.firstName}"/></div><div><label>Achternaam</label><input id="e-ln" value="${e.lastName}"/></div></div>
        <div class="row"><div><label>Team</label><input id="e-team" value="${e.team || ''}"/></div><div><label>Plant</label><select id="e-plant"></select></div></div>
        <div><label>Status</label><select id="e-status"><option value="active">actief</option><option value="locked">geblokkeerd</option><option value="sick">ziek</option></select></div>`; ui.open(html, 'Werknemer bewerken', async () => { await data.employees.update(id, { firstName: $('#e-fn').value, lastName: $('#e-ln').value, team: $('#e-team').value, plantId: $('#e-plant').value, status: $('#e-status').value }); }); fillOptions('plants', '#e-plant', null, e.plantId); setTimeout(() => { $('#e-status').value = e.status || 'active' }, 0);
        }
        async function lockEmployee(id) { await data.employees.update(id, { status: 'locked' }); }
        window.editEmployee = editEmployee; window.lockEmployee = lockEmployee;

        function renderNotifs() { const tbody = $('#notif-rows'); if (!tbody) return; tbody.innerHTML = ''; state.notifications.forEach(n => { const tr = document.createElement('tr'); const ts = n.createdAt?.toDate ? n.createdAt.toDate() : (n.createdAt?.seconds ? new Date(n.createdAt.seconds * 1000) : new Date()); tr.innerHTML = `<td>${ts.toLocaleString()}</td><td>${n.type}</td><td>${n.message}</td><td><button class="btn" onclick='removeNotif("${n.id}")'>Verwijderen</button></td>`; tbody.appendChild(tr); }); const latest = $('#latest-notifs'); latest.innerHTML = state.notifications.slice(0, 5).map(n => `<div>• ${n.message}</div>`).join('') || '<span class="muted">Geen meldingen…</span>'; }
        async function removeNotif(id) { await data.notifications.delete(id); }
        window.removeNotif = removeNotif;

        async function fillOptions(col, sel, mapFn = null, selected = null) { const el = document.querySelector(sel); el.innerHTML = ''; const items = state[col]; items.forEach(d => { const o = document.createElement('option'); o.value = d.id; o.textContent = mapFn ? mapFn(d) : (d.name || d.id); if (selected && selected === d.id) o.selected = true; el.appendChild(o); }); }

        function exportCSV() { const headers = ['Naam', 'Plant', 'Werknemer', 'Duur', 'Status']; const rows = state.tasks.map(t => { const plant = state.plants.find(p => p.id === t.plantId)?.name || ''; const emp = state.employees.find(e => e.id === t.employeeId); const who = emp ? `${emp.firstName} ${emp.lastName}` : ''; return [t.name, plant, who, t.duration || 0, t.status]; }); const csv = [headers, ...rows].map(r => r.map(v => `"${(v ?? '').toString().replaceAll('"', '""')}"`).join(',')).join('\n'); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'taken_export.csv'; a.click(); setTimeout(() => URL.revokeObjectURL(url), 3000); }
        window.exportCSV = exportCSV;

        function notify(type, message) { data.notifications.create({ type, message }); }

        // ===== SUBSCRIPTIONS =====
        let unsubscribers = [];
        function bootSubscriptions() {
            unsubscribers.forEach(u => { try { u() } catch { } }); unsubscribers = [];
            const u1 = data.subscribe('plants', (rows) => { state.plants = rows; renderPlants(); renderTasks(); updateKPIs(); });
            const u2 = data.subscribe('employees', (rows) => { state.employees = rows; renderEmployees(); renderTasks(); updateKPIs(); });
            const u3 = data.subscribe('tasks', (rows) => { state.tasks = rows; renderTasks(); updateKPIs(); });
            const u4 = data.subscribe('notifications', (rows) => { state.notifications = rows.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); renderNotifs(); });
            unsubscribers = [u1 || (() => { }), u2 || (() => { }), u3 || (() => { }), u4 || (() => { })];
        }

        // ===== INIT: try cloud, else banner choice =====
        async function init() {
            try { await data.tryCloud(); bootSubscriptions(); }
            catch (err) { banner.style.display = 'block'; console.warn('Cloud niet beschikbaar, toon keuze', err); }
        }

        $('#retry-btn').onclick = () => location.reload();
        $('#local-btn').onclick = () => data.useLocal();

        init();

        // ===== Firestore Rules (tip, demo) =====
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //     match /{document=**} { allow read, write: if request.time < timestamp.date(2030,1,1); }
        //   }
        // }
    </script>
</body>

</html>